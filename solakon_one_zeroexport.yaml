blueprint:
  name: Solakon ONE Zero Export (EN) - Dynamic & SOC-Controlled (V202)
  description: |
    **Detailed Function Description: Dynamic Zero Export with SOC Zone Logic**

    This Home Assistant Blueprint implements **dynamic zero export** for the Solakon ONE inverter. It uses a **PI controller (Proportional-Integral Controller)** for precise control of AC output power and a **three-stage State-of-Charge (SOC) logic** for efficient battery storage management.

    ---
    ### ðŸ§  PI Controller & Control Logic
    The core of the blueprint is a **PI controller (Proportional-Integral Controller)** that dynamically adjusts the **AC Output Limit** (discharge power).
    
    * **Measurement Principle:** Control is based on the **Shelly/Grid Power Sensor**. **IMPORTANT:** Positive values = consumption, NEGATIVE VALUES = export.
    
    * **P-Component (Proportional):** Responds to current deviation with configurable aggressiveness (control factor).
    
    * **I-Component (Integral):** Accumulates deviations over time and eliminates steady-state errors. Reset on zone changes (Anti-Windup).
    
    * **Power Limiting:** Secured by an **upper hard limit** and a **hardcoded lower limit of 0 W**.

    ---
    ### ðŸ”‹ Three-Stage SOC Zone Logic
    The logic divides the battery state of charge (SOC) into three zones:

    #### Zone 1: Aggressive Control (Discharge Cycle / High SOC)
    * **Condition:** SOC > **Upper Threshold** (`soc_fast_limit`) **OR** discharge cycle active.
    * **Action:** **Max. Discharge Current** is set to standard value (e.g., 40 A).
    * **Control:** PI controller with **zero-point offset of 0 W** for exact zero export.
    * **Behavior:** Once activated, Zone 1 runs until SOC â‰¤ 20% (no yo-yo effect).

    #### Zone 2: Battery-Conserving Control (Mid-SOC)
    * **Condition:** SOC between Lower (`soc_conservation_limit`) and Upper threshold, AND discharge cycle inactive.
    * **Action:** **Max. Discharge Current** is set to **0 A** (discharge only via AC limit).
    * **Control:** PI controller with **zero-point offset** (e.g., 30 W) to shift control target toward slight **grid consumption** (charging).
    * **Dynamic Upper Limit:** Discharge power is capped by **Max(0, PV - Reserve)**.
    * **Night Shutdown:** Optionally, Zone 2 can be disabled when PV < threshold (Zone 1 remains active).

    #### Zone 3: Safety Stop (Low SOC)
    * **Condition:** SOC falls to or below the **Lower Threshold**.
    * **Action:** Immediate switch to **"Disabled"** and setting **AC Output Limit to 0 W**.

    ---
    ### âš™ï¸ Additional Control Mechanisms
    * **Two-Stage Mode Change:** A pulse sequence (10s pulse, then 3599s) is used to secure mode commands.
    * **Timeout Refresh:** Remote Timeout is automatically reset to 3599s when countdown falls below 120s.
    * **Integral Reset:** I-component is reset to 0 on each zone change to prevent windup.
    * **Anti-Windup:** Integral value is limited to Â±1000 points.
      
  domain: automation
  source_url: https://github.com/D4nte85/Solakon-One-Nulleinspeisung-Blueprint-homeassistant/blob/Solakon-ONE-Zero-Export/solakon_one_zeroexport.yaml
  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”Œ GRID SENSOR (External - e.g., Shelly 3EM)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    grid_power_sensor:
      name: ðŸ”Œ Shelly/Grid Power Sensor (REQUIRED)
      description: |
        Sensor for current grid power (e.g., Shelly 3EM).
        âš ï¸ IMPORTANT: Positive values = consumption, NEGATIVE VALUES = export.
      selector:
        entity:
          domain: sensor
          device_class: power
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âš¡ SOLAKON ONE - ENTITIES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    solar_power_sensor:
      name: â˜€ï¸ Solakon ONE - Solar Power (PV Generation)
      description: Current total PV generation in Watts.
      default: sensor.solakon_one_total_pv_power
      selector:
        entity:
          domain: sensor
          device_class: power
    
    soc_sensor:
      name: ðŸ”‹ Solakon ONE - Battery State of Charge (SOC)
      description: Current battery state of charge in %.
      default: sensor.solakon_one_battery_soc
      selector:
        entity:
          domain: sensor
          device_class: battery
    
    remote_timeout_countdown_sensor:
      name: â±ï¸ Solakon ONE - Remote Timeout Countdown
      description: Sensor displaying the remaining timeout countdown.
      default: sensor.solakon_one_remote_timeout_countdown
      selector:
        entity:
          domain: sensor
    
    active_power_number:
      name: âš™ï¸ Solakon ONE - Output Power Controller
      description: Entity for setting the power setpoint (Remote Active Power).
      default: number.solakon_one_remote_active_power
      selector:
        entity:
          domain: number
    
    max_discharge_current_number:
      name: ðŸ”‹ Solakon ONE - Max. Discharge Current
      description: Entity for controlling the maximum discharge current (A).
      default: number.solakon_one_battery_max_discharge_current
      selector:
        entity:
          domain: number
    
    remote_timeout_set_number:
      name: â²ï¸ Solakon ONE - Mode Reset Timer
      description: Used to set/reset the remote timeout (max. 3599 s).
      default: number.solakon_one_remote_timeout_set
      selector:
        entity:
          domain: number
    
    mode_select:
      name: ðŸ”„ Solakon ONE - Operating Mode Selection
      description: Entity for switching the operating mode (Remote Control Mode).
      default: select.solakon_one_remote_control_mode
      selector:
        entity:
          domain: select
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ› ï¸ HOME ASSISTANT HELPER (REQUIRED!)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    cycle_active_input_select:
      name: ðŸ› ï¸ Discharge Cycle State Storage (input_select - REQUIRED!)
      description: |
        âš ï¸ IMPORTANT: Create an Input Select Helper with options 'on' and 'off'.
        Settings â†’ Devices & Services â†’ Helpers â†’ Create Helper â†’ Dropdown
        - Name: e.g., 'SOC Discharge Cycle Status'
        - Options: 'on' and 'off' (exactly like this!)
        
        This stores whether the discharge cycle is active (Zone 1).
      default: input_select.soc_discharge_cycle_status
      selector:
        entity:
          domain: input_select
    
    integral_helper:
      name: ðŸ› ï¸ Integral Storage (input_number - REQUIRED!)
      description: |
        âš ï¸ IMPORTANT: Create an input_number Helper for the PI controller:
        Settings â†’ Devices & Services â†’ Helpers â†’ Create Helper â†’ Number
        - Name: e.g., 'Solakon Integral'
        - Min: -1000
        - Max: 1000
        - Step: 1
        - Initial: 0
        
        This stores the I-component of the PI controller.
      default: input_number.solakon_integral
      selector:
        entity:
          domain: input_number
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŽšï¸ CONTROL PARAMETERS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    regulator_factor:
      name: ðŸŽ›ï¸ P-Factor (Proportional Gain)
      description: |
        P-component of PI controller: Responds to current deviation (e.g., 1.5).
        Higher = faster, more aggressive response | Lower = gentler response
      default: 1.5
      selector:
        number:
          min: 0.1
          max: 5
          step: 0.1
    
    ki_factor:
      name: ðŸŽ›ï¸ I-Factor (Integral Gain)
      description: |
        I-component of PI controller: Eliminates steady-state errors (e.g., 0.05).
        Higher = faster correction, but less stable | Lower = slower, more stable
      default: 0.05
      selector:
        number:
          min: 0.01
          max: 0.2
          step: 0.01
    
    tolerance:
      name: ðŸ“ Tolerance Range (Deadband)
      description: |
        Range in Watts around zero point where NO correction occurs (e.g., Â±25 W).
        Prevents permanent micro-corrections during stable control.
      default: 25
      selector:
        number:
          min: 0
          max: 200
          unit_of_measurement: W
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”‹ SOC ZONE PARAMETERS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    soc_fast_limit:
      name: ðŸ”‹ SOC Threshold "Zone 1 Start" (Aggressive Discharge)
      description: |
        Upper threshold (e.g., 50%).
        Exceeding activates Zone 1 (aggressive discharge with 40A).
        Zone 1 then runs until SOC â‰¤ 20% (no yo-yo effect).
      default: 50
      selector:
        number:
          min: 1
          max: 99
          unit_of_measurement: "%"
    
    soc_conservation_limit:
      name: ðŸ”‹ SOC Threshold "Zone 3 Stop" (Safety Limit)
      description: |
        Lower threshold (e.g., 20%).
        Falling below stops discharge completely (Zone 3 = Disabled).
      default: 20
      selector:
        number:
          min: 1
          max: 49
          unit_of_measurement: "%"
    
    default_discharge_current:
      name: ðŸ”‹ Max. Discharge Current in Zone 1 (Ampere)
      description: |
        Maximum discharge current in Zone 1 (aggressive discharge, e.g., 40 A).
        In Zone 2, automatically set to 0 A (battery-conserving).
      default: 40
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: A
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âš™ï¸ ZONE 2 - PARAMETERS (Battery-Conserving Mode)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    offset:
      name: âš™ï¸ Zone 2 - Zero-Point Offset (Control Target)
      description: |
        Target value for grid power in Zone 2 (e.g., 30 W).
        Positive value = slight grid consumption desired â†’ battery is charged.
        0 W = Exact zero export (like Zone 1).
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: W
    
    pv_charge_reserve:
      name: âš™ï¸ Zone 2 - PV Charge Reserve
      description: |
        PV power reserved for charging in Zone 2 (e.g., 50 W).
        Dynamic upper limit: Max. discharge = PV - Reserve.
        Ensures battery is charged even with trickle charge.
      default: 50
      selector:
        number:
          min: 0
          max: 1000
          unit_of_measurement: W
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”’ SAFETY PARAMETERS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    max_active_power_limit:
      name: ðŸ”’ Maximum Output Power (Hard Limit)
      description: |
        Absolute upper limit of AC output power (e.g., 800 W).
        Protects against inverter overload.
      default: 800
      selector:
        number:
          min: 0
          max: 1200
          unit_of_measurement: W
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŒ™ NIGHT SHUTDOWN (Optional)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    night_shutdown_enabled:
      name: ðŸŒ™ Enable Night Shutdown
      description: |
        Automatically disables Zone 2 at night (when PV < threshold).
        âš ï¸ Zone 1 (aggressive discharge) continues to run at night!
        Useful for battery conservation at 0 PV.
      default: false
      selector:
        boolean:
    
    night_shutdown_pv_threshold:
      name: ðŸŒ™ PV Threshold for "Night"
      description: |
        Below this PV power it is considered night (e.g., 10 W).
        Only relevant if night shutdown is enabled.
      default: 10
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: W
    
mode: queued
max_exceeded: silent

variables:
  # ===========================================
  # BLOCK 1: Variables for Conditions & Mode Logic
  # (Always required)
  # ===========================================
  
  # Zone thresholds
  soc_fast_limit_int: !input soc_fast_limit
  soc_conservation_limit_int: !input soc_conservation_limit
  
  # Current sensor values for conditions
  soc: !input soc_sensor
  timeout_countdown: !input remote_timeout_countdown_sensor
  solakon_mode: !input mode_select
  cycle_active: !input cycle_active_input_select
  
  # Night shutdown config
  night_shutdown_enabled_bool: !input night_shutdown_enabled
  night_pv_threshold: !input night_shutdown_pv_threshold
  solar_power_for_night_check: !input solar_power_sensor
  
  # PI controller helper
  integral_entity: !input integral_helper
  
  # Entities
  active_power_entity: !input active_power_number
  discharge_current_entity: !input max_discharge_current_number
  timeout_set_entity: !input remote_timeout_set_number
  
  # Parameters
  discharge_current_max: !input default_discharge_current

triggers:
  # -------------------------------------------------------------------------------------------------
  # 1. Power Changes (No delay for fast PI control)
  # -------------------------------------------------------------------------------------------------
  - trigger: state
    entity_id: !input grid_power_sensor
    id: grid_power_change

  - trigger: state
    entity_id: !input solar_power_sensor
    id: solar_power_change

  # -------------------------------------------------------------------------------------------------
  # 2. SOC Threshold Reached (Controls zone changes)
  # -------------------------------------------------------------------------------------------------
  - trigger: numeric_state
    entity_id: !input soc_sensor
    above: !input soc_fast_limit
    id: soc_high

  - trigger: numeric_state
    entity_id: !input soc_sensor
    below: !input soc_conservation_limit
    id: soc_low

  # -------------------------------------------------------------------------------------------------
  # 3. Mode Change (Reacts to manual/external change)
  # -------------------------------------------------------------------------------------------------
  - trigger: state
    entity_id: !input mode_select
    id: mode_change

action:
  # -------------------------------------------------------------------------------------------------
  # VALIDATION: Check for critical errors (values and entities)
  # -------------------------------------------------------------------------------------------------
  - choose:
    # CHECK A: SOC Limits
    - conditions:
        - condition: template
          value_template: "{{ soc_fast_limit_int <= soc_conservation_limit_int }}"
      sequence:
        - service: system_log.write
          data:
            level: error
            message: "Solakon ONE Blueprint Error: Upper SOC threshold ({{ soc_fast_limit_int }}%) must be greater than lower SOC threshold ({{ soc_conservation_limit_int }}%). Automation stopped."
        - stop: SOC limits are incorrectly configured.
          
    # CHECK B: Critical entities available
    - conditions:
        - condition: or
          conditions:
            # SOC and timeout countdown: Check directly for 'unknown'/'unavailable'
            - condition: template
              value_template: >
                {{ is_state(soc, 'unknown') or is_state(soc, 'unavailable') or
                   is_state(timeout_countdown, 'unknown') or is_state(timeout_countdown, 'unavailable') }}
            # Grid Power: Will be checked later (after Variables)
            # Mode selector
            - condition: template
              value_template: "{{ is_state(solakon_mode, 'unknown') or is_state(solakon_mode, 'unavailable') }}"
            # Active Power Number
            - condition: template
              value_template: "{{ state_attr(active_power_entity, 'min') is none }}"
      sequence:
        - service: system_log.write
          data:
            level: error
            message: "Solakon ONE Blueprint Error: One or more critical entities (SOC, Timeout sensor, Output power controller) are UNAVAILABLE or have invalid values. Automation stopped."
        - stop: Critical entities are faulty.
          
    default:
      # -------------------------------------------------------------------------------------------------
      # MAIN LOGIC: Mode and Cycle Control (Zone 1, 2, 3)
      # -------------------------------------------------------------------------------------------------
      - choose:
          # CASE A: ZONE 1 - Aggressive Discharge START (SOC > Upper threshold AND Cycle OFF)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) > soc_fast_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Zone Change
                  message: "ðŸ”‹ Zone 1 activated (Aggressive Discharge) - SOC: {{ states(soc) }}%"
                  entity_id: !input soc_sensor
              # Reset integral on zone change
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # 1. Set cycle to 'on'
              - service: input_select.select_option
                data:
                  entity_id: !input cycle_active_input_select
                  option: 'on'
              # 2. Mode change to 'Inverter export (PV priority)' (with pulse sequence for safety)
              - choose:
                  - conditions: "{{ states(solakon_mode) != '1' }}"
                    sequence:
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 10
                      - delay: '00:00:01' 
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 3599
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: '1'
          
          # CASE B: ZONE 3 - Safety STOP (SOC <= Lower threshold AND Cycle ON)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) <= soc_conservation_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'on'
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Zone Change
                  message: "ðŸ›‘ Zone 3 activated (Safety Stop) - SOC: {{ states(soc) }}%"
                  entity_id: !input soc_sensor
              # Reset integral
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # 1. Set cycle to 'off'
              - service: input_select.select_option
                data:
                  entity_id: !input cycle_active_input_select
                  option: 'off'
              # 2. Mode change to 'Disabled'
              - choose:
                  - conditions: "{{ states(solakon_mode) != '0' }}"
                    sequence:
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: '0'
              # 3. Set power limit to 0 W (soft stop)
              - service: number.set_value
                data:
                  entity_id: !input active_power_number
                  value: 0
                  
          # CASE C: ZONE 3 - Safety STOP (Additional safeguard if cycle already OFF but mode active)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) < soc_conservation_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
              - condition: template
                value_template: "{{ states(solakon_mode) != '1' }}"
            sequence:
              # Set mode to 'Disabled'
              - choose:
                  - conditions: "{{ states(solakon_mode) != '0' }}"
                    sequence:
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: '0'
              # Set power limit to 0 W
              - service: number.set_value
                data:
                  entity_id: !input active_power_number
                  value: 0
                  
          # CASE D: ZONE 2 - Battery-Conserving START (P-controller active, but 0 A discharge)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) > soc_conservation_limit_int and states(soc) | float(0) <= soc_fast_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
              - condition: template
                value_template: "{{ states(solakon_mode) != '1' }}"
              # Night check: Only start if NOT night OR function disabled
              - condition: template
                value_template: >
                  {{ not night_shutdown_enabled_bool or 
                     (states(solar_power_for_night_check) | float(0)) >= night_pv_threshold }}
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Zone Change
                  message: "ðŸ”‹ Zone 2 activated (Battery-Conserving) - SOC: {{ states(soc) }}%"
                  entity_id: !input soc_sensor
              # Reset integral on zone change
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # Mode change to 'Inverter export (PV priority)'
              - choose:
                  - conditions: "{{ states(solakon_mode) != '1' }}"
                    sequence:
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 10
                      - delay: '00:00:01'
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 3599
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: '1'
          
          - conditions:
              # Night shutdown enabled
              - condition: template
                value_template: "{{ night_shutdown_enabled_bool }}"
              # It is night (PV below threshold)
              - condition: template
                value_template: "{{ (states(solar_power_for_night_check) | float(0)) < night_pv_threshold }}"
              # Only in Zone 2 (cycle = off)
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
              # Mode is currently active
              - condition: template
                value_template: "{{ states(solakon_mode) == '1' }}"
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Night Mode
                  message: "ðŸŒ™ Night shutdown activated (Zone 2) - PV: {{ states(solar_power_for_night_check) }}W"
                  entity_id: !input solar_power_sensor
              # Reset integral
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # Set mode to 'Disabled'
              - service: select.select_option
                data:
                  entity_id: !input mode_select
                  option: '0'
              # Power limit to 0 W
              - service: number.set_value
                data:
                  entity_id: !input active_power_number
                  value: 0
                          
  # -------------------------------------------------------------------------------------------------
  # ACTION E: PI Controller Logic, Timeout Refresh AND Discharge Limit Protection
  # ONLY execute when mode is active AND (Zone 1 OR Day)!
  # -------------------------------------------------------------------------------------------------
  - condition: template
    value_template: >
      {{ states(solakon_mode) == '1' and
         (is_state(cycle_active, 'on') or 
          not night_shutdown_enabled_bool or
          (states(solar_power_for_night_check) | float(0)) >= night_pv_threshold) }}
    
  # ===========================================
  # BLOCK 2: Variables ONLY for PI Controller
  # (Only calculated when mode is active)
  # ===========================================
  - variables:
      # Grid Power
      grid_power: !input grid_power_sensor
      grid_power_float: "{{ states(grid_power) | float(0) }}"
      
      # Solar Power
      solar_power: !input solar_power_sensor
      solar_power_float: "{{ states(solar_power) | float(0) }}"
      
      # Configuration
      tolerance_int: !input tolerance
      regulator_factor_float: !input regulator_factor
      ki_factor_float: !input ki_factor
      offset_int: !input offset
      max_active_power_limit_int: !input max_active_power_limit
      pv_charge_reserve_int: !input pv_charge_reserve
      
      # PI controller variables
      current_active_power: "{{ states(active_power_entity) | float(0) }}"
        
      # Max Power Limit in Zone 2 = Max(0, PV - Reserve)
      max_zone_2_limit: >
        {% set pv_minus_reserve = solar_power_float - pv_charge_reserve_int %}
        {% if pv_minus_reserve > 0 %}
          {{ pv_minus_reserve }}
        {% else %}
          0
        {% endif %}

      # Target Offset based on zone (0 W in Zone 1, Offset_Int in Zone 2)
      target_offset: >
        {% if is_state(cycle_active, 'on') %}
          0
        {% else %}
          {{ offset_int }}
        {% endif %}
      
      # Tolerance check based on actual grid error (not limited)
      grid_error_for_tolerance: "{{ (grid_power_float - target_offset) | abs }}"
      
     # PI Controller Calculation
      # 1. Current error 
      error: >
        {% if is_state(cycle_active, 'on') %}
          {# ZONE 1: Min(available capacity, Grid) #}
          {{ [(max_active_power_limit_int - current_active_power), grid_power_float] | min | float(0) }}
        {% else %}
          {# ZONE 2: Min(available capacity, Grid - Offset, PV capacity) #}
          {{ [(max_active_power_limit_int - current_active_power), (grid_power_float - offset_int), (max_zone_2_limit - current_active_power)] | min | float(0) }}
        {% endif %}
      
      # 2. Integral with Anti-Windup
      integral_old: "{{ states(integral_entity) | float(0) }}"
      integral_new: >
        {% set error_float = error | float(0) %}
        {% if grid_error_for_tolerance > tolerance_int %}
          {{ [[-1000, integral_old + error_float] | max, 1000] | min | float(0) }}
        {% elif integral_old | abs > 10 %}
          {{ (integral_old * 0.95) | float(0) }}
        {% else %}
          {{ integral_old | float(0) }}
        {% endif %}
      
      # 3. PI correction (P-component + I-component)
      power_correction_pi: >
        {% set error_float = error | float(0) %}
        {% set integral_float = integral_new | float(0) %}
        {% set p_part = error_float * regulator_factor_float %}
        {% set i_part = integral_float * ki_factor_float %}
        {{ (p_part + i_part) | float(0) }}
      
      # 4. New power setpoint
      new_power_unlimited: >
        {% set correction = power_correction_pi | float(0) %}
        {{ (current_active_power + correction) | float(0) }}
        
      # 5. Final Power: Logic combined in one template
      final_power_calculated: >
        {% set p_regler_power = new_power_unlimited | float(0) %}
        {% if is_state(cycle_active, 'on') %}
          {# ZONE 1: Hard Limit #}
          {{ [max_active_power_limit_int, p_regler_power] | min | float(0) }}
        {% else %}
          {# ZONE 2: Dynamic PV Limit #}
          {% set max_zone_2 = max_zone_2_limit | float(0) %}
          {{ [max_zone_2, p_regler_power] | min | float(0) }}
        {% endif %}
        
  - choose:
      # CASE E.1: Set limit for Zone 1 (Aggressive)
      - conditions:
          - condition: state
            entity_id: !input cycle_active_input_select
            state: 'on'
          - condition: template
            value_template: >
              {# Check if current value does NOT match maximum value #}
              {{ states(discharge_current_entity) | float(999) | round(2) != discharge_current_max | float(0) | round(2) }}
        sequence:
          - service: number.set_value
            data:
              entity_id: !input max_discharge_current_number
              value: "{{ discharge_current_max }}"
              
      # CASE E.2: Set limit for Zone 2 (Battery-conserving = 0 A)
      - conditions:
          - condition: state
            entity_id: !input cycle_active_input_select
            state: 'off'
          - condition: template
            value_template: >
              {# Check if current value does NOT equal 0 A #}
              {{ states(discharge_current_entity) | float(999) | round(2) != 0 }}
        sequence:
          - service: number.set_value
            data:
              entity_id: !input max_discharge_current_number
              value: 0

  # 2. Timeout Reset
  - choose: 
        # Timeout reset required
      - conditions:
          - condition: template
            value_template: "{{ states(timeout_countdown) | int(9999) < 120 }}"
        sequence:
          - service: number.set_value
            data:
              entity_id: !input remote_timeout_set_number
              value: 10
          - delay: '00:00:01'
          - service: number.set_value
            data:
              entity_id: !input remote_timeout_set_number
              value: 3599
              
  # 3. Save integral
  - service: input_number.set_value
    data:
      entity_id: !input integral_helper
      value: "{{ integral_new }}"
      
  # 4. Set power limit (Only when tolerance is exceeded)
  - condition: template
    value_template: "{{ grid_error_for_tolerance > tolerance_int }}"
  
  - service: number.set_value
    data:
      entity_id: !input active_power_number
      value: "{{ [0, final_power_calculated] | max | round(0) }}"
  - delay: '00:00:03'





