blueprint:
  name: Solakon ONE Zero Export (PI Controller with 3-Stage SOC Logic)
  description: >
    Dynamic zero export for the Solakon ONE inverter with modern PI controller and intelligent 
    three-stage battery state-of-charge logic. Features automatic discharge current control, 
    anti-windup protection, and optional night shutdown.
    
    
    **Key Features:**
    
    - Modern PI controller (Proportional-Integral) for precise zero export
    
    - Three-stage SOC logic (Aggressive Discharge / Battery Protection / Safety Stop)
    
    - Automatic max. discharge current control (40A in Zone 1, 0A in Zone 2)
    
    - Anti-Windup with tolerance decay
    
    - Optional night shutdown for Zone 2
    
    - Reliable communication with continuous timeout reset
    
    
    **Prerequisites:** Two helpers must be created before installation:
    
    1. Input Select (Dropdown) with options "on" and "off"
    
    2. Input Number with range -1000 to 1000, step 1, initial 0
    
    
    See full documentation for detailed setup instructions and usage examples.
    
  domain: automation
  source_url: https://github.com/D4nte85/Solakon-One-Nulleinspeisung-Blueprint-homeassistant/blob/main/solakon_one_nulleinspeisung_en.yaml
  
  input:
    # ========================================
    # External Sensors
    # ========================================
    grid_power_sensor:
      name: Grid Power Sensor
      description: >
        Power sensor for grid measurement (e.g., Shelly 3EM).
        Positive values = grid import, negative values = grid export.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: power
    
    # ========================================
    # Solakon ONE Entities
    # ========================================
    solar_power:
      name: Solar Power
      description: Current PV generation in watts
      default: sensor.solakon_one_total_pv_power
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: power
    
    battery_soc:
      name: Battery State of Charge (SOC)
      description: Battery charge level in %
      default: sensor.solakon_one_battery_soc
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: battery
    
    remote_timeout_countdown:
      name: Remote Timeout Countdown
      description: Remaining timeout countdown
      default: sensor.solakon_one_remote_timeout_countdown
      selector:
        entity:
          filter:
            - domain: sensor
    
    output_power_control:
      name: Output Power Controller
      description: Sets power setpoint
      default: number.solakon_one_remote_active_power
      selector:
        entity:
          filter:
            - domain: number
    
    max_discharge_current:
      name: Max. Discharge Current
      description: Sets discharge current limit
      default: number.solakon_one_battery_max_discharge_current
      selector:
        entity:
          filter:
            - domain: number
    
    remote_timeout_set:
      name: Mode Reset Timer
      description: Sets/Resets timeout (max. 3599s)
      default: number.solakon_one_remote_timeout_set
      selector:
        entity:
          filter:
            - domain: number
    
    remote_control_mode:
      name: Operating Mode Selection
      description: Switches operating mode
      default: select.solakon_one_remote_control_mode
      selector:
        entity:
          filter:
            - domain: select
    
    # ========================================
    # Helper Entities
    # ========================================
    discharge_cycle_status:
      name: Discharge Cycle Status (Input Select)
      description: >
        Helper to store discharge cycle state.
        Must be an Input Select with options "on" and "off".
      default: input_select.soc_discharge_cycle_status
      selector:
        entity:
          filter:
            - domain: input_select
    
    integral_helper:
      name: Integral Helper (Input Number)
      description: >
        Helper to store integral value.
        Must be an Input Number with range -1000 to 1000, step 1.
      default: input_number.solakon_integral
      selector:
        entity:
          filter:
            - domain: input_number
    
    # ========================================
    # PI Controller Parameters
    # ========================================
    p_factor:
      name: P Factor (Proportional Gain)
      description: >
        Proportional gain. Higher = more aggressive, faster response.
        Default: 1.5
      default: 1.5
      selector:
        number:
          min: 0.1
          max: 5.0
          step: 0.1
          mode: slider
    
    i_factor:
      name: I Factor (Integral Gain)
      description: >
        Integral gain. Higher = faster error correction, but less stable.
        Default: 0.05
      default: 0.05
      selector:
        number:
          min: 0.01
          max: 0.2
          step: 0.01
          mode: slider
    
    tolerance:
      name: Tolerance Range
      description: >
        Dead band around control target. No correction within this zone.
        Default: 25 W
      default: 25
      selector:
        number:
          min: 0
          max: 200
          step: 5
          unit_of_measurement: "W"
          mode: slider
    
    # ========================================
    # SOC Thresholds
    # ========================================
    soc_high_threshold:
      name: Zone 1 Start (Upper SOC Threshold)
      description: >
        SOC threshold to activate Zone 1 (Aggressive Discharge).
        Must be greater than lower threshold.
        Default: 50%
      default: 50
      selector:
        number:
          min: 1
          max: 99
          step: 1
          unit_of_measurement: "%"
          mode: slider
    
    soc_low_threshold:
      name: Zone 3 Stop (Lower SOC Threshold)
      description: >
        SOC threshold to activate Zone 3 (Safety Stop).
        Must be less than upper threshold.
        Default: 20%
      default: 20
      selector:
        number:
          min: 1
          max: 49
          step: 1
          unit_of_measurement: "%"
          mode: slider
    
    max_discharge_current_zone1:
      name: Max. Discharge Current Zone 1
      description: >
        Discharge current limit in Zone 1 (Aggressive Discharge).
        Zone 2 automatically uses 0 A.
        Default: 40 A
      default: 40
      selector:
        number:
          min: 0
          max: 40
          step: 1
          unit_of_measurement: "A"
          mode: slider
    
    # ========================================
    # Zero Point & PV Reserve
    # ========================================
    zero_point_offset:
      name: Zero Point Offset
      description: >
        Control target in Zone 2. Positive = slight grid import (battery charges).
        0W = exact zero export.
        Default: 30 W
      default: 30
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "W"
          mode: slider
    
    pv_charge_reserve:
      name: PV Charging Reserve
      description: >
        Reserved PV power for battery charging.
        Dynamic limit: Max(0, PV - Reserve).
        Default: 50 W
      default: 50
      selector:
        number:
          min: 0
          max: 1000
          step: 10
          unit_of_measurement: "W"
          mode: slider
    
    # ========================================
    # Power Limits
    # ========================================
    max_output_power:
      name: Max. Output Power (Hard Limit)
      description: >
        Absolute upper limit in Zone 1 for inverter protection.
        Default: 800 W
      default: 800
      selector:
        number:
          min: 0
          max: 1200
          step: 50
          unit_of_measurement: "W"
          mode: slider
    
    # ========================================
    # Night Shutdown
    # ========================================
    enable_night_shutdown:
      name: Enable Night Shutdown
      description: >
        Enable automatic shutdown of Zone 2 when PV power is below threshold.
        Zone 1 continues running at night.
        Default: Off
      default: false
      selector:
        boolean:
    
    night_pv_threshold:
      name: PV Threshold for "Night"
      description: >
        PV power threshold below which it's considered night.
        Only applies when night shutdown is enabled.
        Default: 10 W
      default: 10
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "W"
          mode: slider

# ========================================
# Automation Logic
# ========================================
mode: queued
max_exceeded: silent

trigger:
  # Grid power change - immediate PI control
  - platform: state
    entity_id: !input grid_power_sensor
    id: grid_power_change
  
  # Solar power change - dynamic PV limit in Zone 2
  - platform: state
    entity_id: !input solar_power
    id: solar_power_change
  
  # SOC crosses upper threshold
  - platform: numeric_state
    entity_id: !input battery_soc
    above: !input soc_high_threshold
    id: soc_high
  
  # SOC crosses lower threshold
  - platform: numeric_state
    entity_id: !input battery_soc
    below: !input soc_low_threshold
    id: soc_low
  
  # Mode change detection
  - platform: state
    entity_id: !input remote_control_mode
    id: mode_change

variables:
  # Input parameters
  grid_power_sensor: !input grid_power_sensor
  solar_power: !input solar_power
  battery_soc: !input battery_soc
  remote_timeout_countdown: !input remote_timeout_countdown
  output_power_control: !input output_power_control
  max_discharge_current: !input max_discharge_current
  remote_timeout_set: !input remote_timeout_set
  remote_control_mode: !input remote_control_mode
  discharge_cycle_status: !input discharge_cycle_status
  integral_helper: !input integral_helper
  
  # Controller parameters
  p_factor: !input p_factor
  i_factor: !input i_factor
  tolerance: !input tolerance
  
  # SOC thresholds
  soc_high_threshold: !input soc_high_threshold
  soc_low_threshold: !input soc_low_threshold
  max_discharge_current_zone1: !input max_discharge_current_zone1
  
  # Zero point & reserve
  zero_point_offset: !input zero_point_offset
  pv_charge_reserve: !input pv_charge_reserve
  
  # Power limits
  max_output_power: !input max_output_power
  
  # Night shutdown
  enable_night_shutdown: !input enable_night_shutdown
  night_pv_threshold: !input night_pv_threshold
  
  # Current sensor values
  soc: "{{ states(battery_soc) | float(0) }}"
  grid_power: "{{ states(grid_power_sensor) | float(0) }}"
  pv_power: "{{ states(solar_power) | float(0) }}"
  current_output: "{{ states(output_power_control) | float(0) }}"
  current_discharge_current: "{{ states(max_discharge_current) | float(0) }}"
  timeout_countdown: "{{ states(remote_timeout_countdown) | int(0) }}"
  current_mode: "{{ states(remote_control_mode) }}"
  cycle_status: "{{ states(discharge_cycle_status) }}"
  
  # Capacity limits
  output_min: "{{ state_attr(output_power_control, 'min') | float(0) }}"
  output_max: "{{ state_attr(output_power_control, 'max') | float(1200) }}"
  
  # Zone determination
  is_zone_3: "{{ soc <= soc_low_threshold }}"
  is_zone_1_active: "{{ cycle_status == 'on' }}"
  should_start_zone_1: "{{ soc > soc_high_threshold and cycle_status == 'off' }}"
  is_zone_2: "{{ not is_zone_3 and not is_zone_1_active }}"
  
  # Night detection (only for Zone 2)
  is_night: "{{ enable_night_shutdown and pv_power < night_pv_threshold }}"
  
  # Available capacity calculation
  available_capacity: "{{ [output_max - current_output, 0] | max }}"
  
  # Dynamic Zone 2 limit (PV power minus charging reserve)
  max_zone_2_limit: "{{ [pv_power - pv_charge_reserve, 0] | max }}"
  
  # ========================================
  # PI Controller Calculation
  # ========================================
  
  # 1. Current error calculation based on zone
  error: >
    {% if cycle_status == 'on' %}
      {# ZONE 1: Min(available capacity, grid power) #}
      {{ [available_capacity, grid_power] | min | float(0) }}
    {% else %}
      {# ZONE 2: Min(available capacity, grid - offset, PV capacity) #}
      {{ [available_capacity, grid_power - zero_point_offset, max_zone_2_limit - current_output] | min | float(0) }}
    {% endif %}
  
  # 2. Integral with anti-windup and tolerance decay
  integral_old: "{{ states(integral_helper) | float(0) }}"
  integral_new: >
    {% set error_float = error | float(0) %}
    {% if error_float | abs > tolerance %}
      {# Accumulate integral within bounds #}
      {{ [[-1000, integral_old + error_float] | max, 1000] | min | float(0) }}
    {% elif integral_old | abs > 10 %}
      {# Decay integral slowly when within tolerance #}
      {{ (integral_old * 0.95) | float(0) }}
    {% else %}
      {# Keep small integral values stable #}
      {{ integral_old | float(0) }}
    {% endif %}
  
  # 3. PI correction (P-part + I-part)
  power_correction_pi: >
    {% set error_float = error | float(0) %}
    {% set integral_float = integral_new | float(0) %}
    {% set p_part = error_float * p_factor %}
    {% set i_part = integral_float * i_factor %}
    {{ (p_part + i_part) | float(0) }}
  
  # 4. New power setpoint (unlimited)
  new_power_unlimited: >
    {% set correction = power_correction_pi | float(0) %}
    {{ (current_output + correction) | float(0) }}
  
  # 5. Final power with zone-dependent limiting
  new_power: >
    {% set p_controller_power = new_power_unlimited | float(0) %}
    {% if is_zone_3 %}
      {# ZONE 3: Safety stop #}
      0
    {% elif cycle_status == 'on' %}
      {# ZONE 1: Hard limit for inverter protection #}
      {{ [max_output_power, p_controller_power, output_max] | min | max(output_min) }}
    {% elif is_zone_2 and not is_night %}
      {# ZONE 2: Dynamic PV limit #}
      {% set max_zone_2 = max_zone_2_limit | float(0) %}
      {{ [max_zone_2, p_controller_power, output_max] | min | max(output_min) }}
    {% else %}
      {# ZONE 2 Night: Shutdown #}
      0
    {% endif %}
  
  # Target discharge current based on zone
  target_discharge_current: >
    {% if is_zone_1_active %}
      {{ max_discharge_current_zone1 }}
    {% else %}
      0
    {% endif %}
  
  # Target mode based on zone
  target_mode: >
    {% if is_zone_3 or (is_zone_2 and is_night) %}
      Disabled
    {% else %}
      INV Discharge (PV Priority)
    {% endif %}

condition:
  # Validate configuration
  - condition: template
    value_template: "{{ soc_high_threshold > soc_low_threshold }}"
    alias: "Upper SOC threshold must be greater than lower threshold"
  
  # Check sensor availability
  - condition: template
    value_template: "{{ states(battery_soc) not in ['unknown', 'unavailable'] }}"
    alias: "SOC sensor must be available"
  
  - condition: template
    value_template: "{{ states(remote_timeout_countdown) not in ['unknown', 'unavailable'] }}"
    alias: "Timeout countdown sensor must be available"
  
  - condition: template
    value_template: "{{ states(remote_control_mode) not in ['unknown', 'unavailable'] }}"
    alias: "Mode selector must be available"
  
  - condition: template
    value_template: "{{ output_min is not none and output_max is not none }}"
    alias: "Output power controller must have min/max attributes"

action:
  # ========================================
  # Timeout Management
  # ========================================
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ timeout_countdown < 120 }}"
        sequence:
          - service: number.set_value
            target:
              entity_id: !input remote_timeout_set
            data:
              value: 3599
  
  # ========================================
  # Zone State Management
  # ========================================
  
  # Start Zone 1 (Aggressive Discharge)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ should_start_zone_1 }}"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input discharge_cycle_status
            data:
              option: "on"
          
          # Reset integral on zone change
          - service: input_number.set_value
            target:
              entity_id: !input integral_helper
            data:
              value: 0
  
  # Stop Zone 1 / Activate Zone 3 (Safety Stop)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_zone_3 and cycle_status == 'on' }}"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input discharge_cycle_status
            data:
              option: "off"
          
          # Reset integral on zone change
          - service: input_number.set_value
            target:
              entity_id: !input integral_helper
            data:
              value: 0
  
  # ========================================
  # Mode Control
  # ========================================
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ current_mode != target_mode }}"
        sequence:
          # Change mode
          - service: select.select_option
            target:
              entity_id: !input remote_control_mode
            data:
              option: "{{ target_mode }}"
          
          # Forced timeout reset with pulse sequence
          - service: number.set_value
            target:
              entity_id: !input remote_timeout_set
            data:
              value: 10
          
          - delay:
              seconds: 1
          
          - service: number.set_value
            target:
              entity_id: !input remote_timeout_set
            data:
              value: 3599
  
  # ========================================
  # Discharge Current Control
  # ========================================
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ current_discharge_current != target_discharge_current }}"
        sequence:
          - service: number.set_value
            target:
              entity_id: !input max_discharge_current
            data:
              value: "{{ target_discharge_current }}"
  
  # ========================================
  # Power Output Control
  # ========================================
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (new_power - current_output) | abs > tolerance }}"
        sequence:
          # Update integral
          - service: input_number.set_value
            target:
              entity_id: !input integral_helper
            data:
              value: "{{ integral_new }}"
          
          # Set new power
          - service: number.set_value
            target:
              entity_id: !input output_power_control
            data:
              value: "{{ new_power | round(0) }}"
          
          # Wait for stabilization
          - delay:
              seconds: 3

